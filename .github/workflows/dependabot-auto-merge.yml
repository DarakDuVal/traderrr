name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: write
  statuses: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Get Dependabot metadata
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@v1.6.0
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Enable auto-merge for Dependabot PRs
        if: |
          contains(steps.dependabot-metadata.outputs.dependency-names, '') == false ||
          steps.dependabot-metadata.outputs.update-type == 'version-update:semver-major' ||
          steps.dependabot-metadata.outputs.update-type == 'version-update:semver-minor' ||
          steps.dependabot-metadata.outputs.update-type == 'version-update:semver-patch'
        run: |
          gh pr merge --auto --squash "$PR_NUMBER"
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Approve Dependabot PR
        run: |
          gh pr review --approve "$PR_NUMBER"
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-check:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    needs: [dependabot]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Get PR details
        id: pr-info
        run: |
          echo "title=$(gh pr view $PR_NUMBER --json title -q .title)" >> $GITHUB_OUTPUT
          echo "labels=$(gh pr view $PR_NUMBER --json labels -q '.labels[].name' | tr '\n' ',')" >> $GITHUB_OUTPUT
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for security vulnerability
        id: security-check
        run: |
          TITLE="${{ steps.pr-info.outputs.title }}"
          LABELS="${{ steps.pr-info.outputs.labels }}"

          # Detect severity from PR title/labels
          if [[ "$TITLE" == *"security"* ]] || [[ "$LABELS" == *"security"* ]]; then
            # Extract severity from dependency
            if [[ "$TITLE" == *"critical"* ]] || [[ "$LABELS" == *"critical"* ]]; then
              echo "severity=critical" >> $GITHUB_OUTPUT
              echo "should_auto_merge=true" >> $GITHUB_OUTPUT
            elif [[ "$TITLE" == *"high"* ]] || [[ "$LABELS" == *"high"* ]]; then
              echo "severity=high" >> $GITHUB_OUTPUT
              echo "should_auto_merge=true" >> $GITHUB_OUTPUT
            else
              echo "severity=medium" >> $GITHUB_OUTPUT
              echo "should_auto_merge=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "severity=unknown" >> $GITHUB_OUTPUT
            echo "should_auto_merge=false" >> $GITHUB_OUTPUT
          fi

      - name: Add comment on security update
        if: steps.security-check.outputs.severity != 'unknown'
        run: |
          gh pr comment $PR_NUMBER --body "üîí **Security Update Detected**

          Severity Level: **${{ steps.security-check.outputs.severity }}**

          This is an automated security update. If this is a critical or high severity vulnerability, this PR will be auto-merged after all checks pass."
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  wait-for-status-checks:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    needs: [dependabot, security-check]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for status checks to complete
        uses: actions/github-script@v8
        with:
          script: |
            const maxRetries = 60;
            const delaySeconds = 10;
            let retries = 0;

            while (retries < maxRetries) {
              const checkRuns = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.head_ref || context.sha,
              });

              const statuses = checkRuns.data.check_runs.filter(run =>
                run.name !== 'Dependabot Auto-Merge' &&
                run.name !== 'Wait for status checks to complete'
              );

              const allCompleted = statuses.every(status =>
                status.status === 'completed'
              );

              if (allCompleted) {
                const allPassed = statuses.every(status =>
                  status.conclusion === 'success'
                );

                if (allPassed) {
                  console.log('‚úÖ All checks passed!');
                  return;
                } else {
                  const failures = statuses
                    .filter(s => s.conclusion !== 'success')
                    .map(s => `${s.name}: ${s.conclusion}`)
                    .join('\n');
                  throw new Error(`‚ùå Some checks failed:\n${failures}`);
                }
              }

              console.log(`Status checks not yet complete. Waiting... (${retries + 1}/${maxRetries})`);
              await new Promise(resolve => setTimeout(resolve, delaySeconds * 1000));
              retries++;
            }

            throw new Error('‚è±Ô∏è Status checks took too long to complete');

      - name: Enable auto-merge after all checks pass
        if: success()
        run: |
          gh pr merge --auto --squash "$PR_NUMBER" || true
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
